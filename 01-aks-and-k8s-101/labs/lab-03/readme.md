# lab-03 - Containerizing your application

## Estimated completion time - xx min

To work with and learn Kubernetes commands we need a test application that we will deploy. I will use the simplest version of `ASP.NET Core Web API` with `WeatherForecast` controller. We will add Docker support, containerize it, push to the Azure Container Registry (ACR) and will run it in AKS.

## Goals

* Get familiar with our test application
* Add Docker support 
* Learn how to create docker image
* Learn how to build and push docker image to Azure Container Registry with `az acr build` command 
* Learn how to run application at AKS
* Learn how to use port forward to test application

## Prerequisites

First, check that all Prerequisites are installed
* [Docker for Windows](https://docs.docker.com/docker-for-windows/install/)
* Visual Studio `.NET Core cross-platform development` workload is installed. If you already have VS installed, you can modify it from `Visual Studio Installer`. If you do a fresh install, you can select workloads during installation. 

![vs-workloads](images/vs-workloads.png)

## Task #1 - open and build application

Use Visual Studio community edition and `app\apps.sln` solution. 
If you use other IDE, like Rider or VS Code, feel free to use them as long as you can follow along. Note some of the VS functionality will not be available, but you can add assets, generated by VS manually.

Now build `Ctrl+Shift+B` and run application your application. It should open the following URL `http://localhost:5000/WeatherForecast` in your default browser and show the list of weather forecast items.
If it doesn't build, check the errors, fix them and build again.


## Task #2 - add Docker support

To add Docker support to your web api app, right-click the `api-a` project, navigate to `Add`, and select `Docker Support`.

![add-docker-support](images/vs-add-docker-support.png)

Make sure that `Linux` is selected and click `OK`.

![add-docker-support](images/vs-add-docker-support-os.png)

Visual Studio will create a `Dockerfile` for you, which defines how to create the container image for your web api project. It will also add new execution profile called `Docker`

![add-docker-support](images/vs-docker-support-profile.png)

If you select it and run the application, it will be running in the docker container, you can check it by running the following command:

```powershell
docker ps
CONTAINER ID   IMAGE      COMMAND               CREATED         STATUS         PORTS                   NAMES
d69999d6ae12   apia:dev   "tail -f /dev/null"   4 seconds ago   Up 3 seconds   0.0.0.0:49156->80/tcp   api-a
```

## Task #3 - deploy `api-a` container to a Azure Container Registry using Visual Studio

When you tested your application and it works locally, you can publish you container image to the Azure Container Registry. The simplest way is to use VS click-ops:

1. Right-click your project in Solution Explorer and choose `Publish`.
2. On the Publish dialog, select `Docker Container Registry`.

![deploy-to-acr-step1](images/publish-to-acr-step1.png)

3. Choose Create New Azure Container Registry.

![deploy-to-acr-step2](images/publish-to-acr-step2.png)

4. Fill in your desired values in the `Azure Container Registry` screen. At this step, you may be asked to login to your Azure account.

![deploy-to-acr-step3](images/publish-to-acr-step3.png)

If you follow our naming convention, the resource group should be `iac-aks-ws1-rg` and your ACR name should be `iacaksws1<YOU-NAME>`.

5. When all is set, click `Publish`

![deploy-to-acr-step4](images/publish-to-acr-step4.png)

Visual Studio is now will build and push container to the ACR registry. 

6. Check ACR registry at the Azure portal

Navigate to Azure portal and search for your ACR. You can use search at the top of the portal 

![search-acr](images/portal-acr-1.png)

Navigate to `Repositories`, select repository `apia` and choose `latest` image. 

![acr](images/portal-acr-2.png)

Here you can find metadata about container image, image url and example of command how to pull it with docker.

## Task #4 - build and push container image with `az acr build` command

You can build and push your images using `az acr ` cli command. To do so, run the following command from within the `api-a` project folder. Note that this time we used `:v1` as a image version.

```powershell
az acr build --registry iacaksws1<YOU-NAME> --image apia:v1 --file Dockerfile ..
```
If command runs successful, check the ACR at the Azure portal. Now `apia` registry should have 2 versions of the image.

![acr1](images/portal-acr-3.png)

## Task #5 - run command at Azure Kubernetes Cluster

Now that we have image at the ACR, and our AKS cluster is integrated with ACR, we can run this image at the AKS

```powershell
kubectl run app-a --image iacaksws1<YOU-NAME>.azurecr.io/apia:v1
pod/app-a created
```

Now you can check the status of the your application 

```powershell
kubectl get po -w
NAME    READY   STATUS              RESTARTS   AGE
app-a   0/1     ContainerCreating   0          9s
app-a   1/1     Running             0          12s
```

`-w` flag is a short version of `--watch` and after listing/getting the requested object, it will watch for changes. As you can see, `app-a` pod was first in `ContainerCreating` state and then eventually changed the status to `Running`.

We can check application logs by running the following command

```powershell
kubectl logs app-a
info: Microsoft.Hosting.Lifetime[0]
      Now listening on: http://[::]:80
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app
```

if you want to continuously observe logs, use `-f` flag

```powershell
kubectl logs app-a -f
info: Microsoft.Hosting.Lifetime[0]
      Now listening on: http://[::]:80
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app
```

## Task #5 - use port-forward to test application

```powershell
kubectl port-forward app-a 7000:80
Forwarding from 127.0.0.1:7000 -> 80
Forwarding from [::1]:7000 -> 80
```


## Useful links

* [Visual Studio 2019 Community Edition](https://visualstudio.microsoft.com/downloads/)
* [Download .NET 5.0](https://dotnet.microsoft.com/download/dotnet/5.0)
* [Create your first Docker container with an ASP.NET web app](https://tutorials.visualstudio.com/aspnet-container/containerize)
* [Visual Studio Container Tools with ASP.NET Core](https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/docker/visual-studio-tools-for-docker?view=aspnetcore-5.0)
* [Container Tools in Visual Studio](https://docs.microsoft.com/en-us/visualstudio/containers/?view=vs-2019)
* [How to configure Visual Studio Container Tools](https://docs.microsoft.com/en-us/visualstudio/containers/container-tools-configure?view=vs-2019)

## Next: Creating and managing pods

[Go to lab-04](../lab-04/readme.md)
